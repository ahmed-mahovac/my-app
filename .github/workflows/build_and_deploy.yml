name: Build and Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:

    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3

    - name: Validate composer.json and composer.lock
      run: |
        cd backend
        composer validate --strict

    - name: Build the Backend Docker image
      run: docker build . --file ./backend/Dockerfile --tag backend:latest

    - name: Build the Frontend Docker image
      run: docker build . --file ./frontend/Dockerfile --tag frontend:latest

    - name: run docker compose
      run: docker-compose up -d